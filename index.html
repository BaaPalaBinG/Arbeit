<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Uren & Kilometers Registratie</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #f2f2f2;
      --card-bg: #ffffff;
      --text: #222222;
      --muted: #555555;
      --border: #d0d0d0;
      --chip-bg: #e0e0e0;
      --entry-bg: #fafafa;
      --pill-bg: #e8f0ff;
      --pill-text: #1a3e90;
      --lock-pill-bg: #ffe5b5;
      --lock-pill-text: #7a4a00;
      --toast-bg: #222222;
    }

    body.dark {
      --bg: #050509;
      --card-bg: #111119;
      --text: #f5f5f7;
      --muted: #a0a0b5;
      --border: #303040;
      --chip-bg: #202230;
      --entry-bg: #15151f;
      --pill-bg: #1f2845;
      --pill-text: #d0ddff;
      --lock-pill-bg: #4a3518;
      --lock-pill-text: #ffd8a0;
      --toast-bg: #000000;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.2rem;
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .nav-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: var(--chip-bg);
      padding: 3px;
    }

    .nav-tabs button {
      border: none;
      background: transparent;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--text);
    }

    .nav-tabs button.active {
      background: var(--card-bg);
      box-shadow: 0 0 0 1px var(--border);
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 14px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px 12px;
    }

    label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 3px;
    }

    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      background: var(--card-bg);
      color: var(--text);
    }

    input:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 1px rgba(0,122,255,0.2);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    button.primary {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      background: #007aff;
      color: #fff;
      cursor: pointer;
    }

    button.secondary {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      background: transparent;
      color: var(--text);
      cursor: pointer;
    }

    button.secondary.small {
      padding: 6px 10px;
      font-size: 0.75rem;
    }

    button:active {
      transform: scale(0.98);
    }

    .small-hint {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .entry-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 8px 0;
      font-size: 0.8rem;
    }

    .entry-actions select {
      max-width: 260px;
    }

    .entry-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
      margin-top: 4px;
    }

    /* compacte grid layout */
    .entry-item {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--entry-bg);
      font-size: 0.8rem;

      display: grid;
      grid-template-columns: auto 70px 120px 1fr auto;
      align-items: center;
      gap: 10px;
      min-height: 30px;
    }

    .entry-item.locked {
      border-style: dashed;
      opacity: 0.95;
    }

    .entry-item input[type="checkbox"] {
      transform: scale(1.05);
      margin: 0;
    }

    .entry-date {
      white-space: nowrap;
      opacity: 0.85;
    }

    .entry-time {
      white-space: nowrap;
    }

    .entry-clientjob {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      opacity: 0.9;
    }

    .entry-right {
      white-space: nowrap;
      text-align: right;
      font-weight: 500;
      opacity: 0.85;
    }

    .pill {
      display: inline-block;
      font-size: 0.7rem;
      padding: 1px 5px;
      border-radius: 999px;
      background: var(--pill-bg);
      color: var(--pill-text);
    }

    .lock-pill {
      display: inline-block;
      font-size: 0.65rem;
      padding: 1px 5px;
      border-radius: 999px;
      background: var(--lock-pill-bg);
      color: var(--lock-pill-text);
      margin-left: 6px;
    }

    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    .totals {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .total-box {
      flex: 1;
      min-width: 120px;
      background: var(--entry-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 0.8rem;
    }

    .total-label {
      color: var(--muted);
      font-size: 0.75rem;
    }

    .total-value {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .overview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 8px;
    }

    .overview-table th,
    .overview-table td {
      border-bottom: 1px solid #333;
      padding: 4px 3px;
      text-align: left;
      white-space: nowrap;
    }

    .overview-table th {
      font-weight: 600;
      font-size: 0.7rem;
      color: var(--muted);
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 1;
    }

    .toast {
      position: fixed;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--toast-bg);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 9999;
    }

    .toast.show {
      opacity: 0.9;
    }

    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 4px;
    }

    .theme-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      padding: 0;
      font-size: 1rem;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Uren & Kilometer Registratie</h1>
    <div class="header-right">
      <div class="nav-tabs">
        <button id="tabInput" class="active" type="button">Invoer</button>
        <button id="tabOverview" type="button">Overzicht</button>
      </div>
      <button id="themeToggle" class="secondary small theme-toggle" type="button" title="Wissel thema">üåô</button>
    </div>
  </header>

  <!-- SCHERM 1: INVOER -->
  <section id="screenInput" class="screen active">
    <div class="card">
      <div class="form-grid">
        <div>
          <label for="date">Datum</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label for="timeFrom">Tijd van</label>
          <input id="timeFrom" type="time" />
        </div>
        <div>
          <label for="timeTo">Tijd tot</label>
          <input id="timeTo" type="time" />
        </div>
        <div>
          <label for="hours">Uren (h)</label>
          <input id="hours" type="number" step="0.25" placeholder="Bijv. 8" />
        </div>
        <div>
          <label for="km">Kilometers (km)</label>
          <input id="km" type="number" step="1" placeholder="Bijv. 245" />
        </div>
        <div>
          <label for="client">Opdrachtgever</label>
          <input id="client" type="text" list="clientList" placeholder="Bijv. Saybolt" />
          <datalist id="clientList"></datalist>
        </div>
        <div>
          <label for="job">Job / Locatie</label>
          <input id="job" type="text" placeholder="Bijv. GISELA ESSBERGER" />
        </div>
      </div>

      <div class="btn-row">
        <button id="saveEntry" type="button" class="primary">Opslaan</button>
        <button id="copyLast" type="button" class="secondary">
          Kopieer laatste naar WhatsApp
        </button>
      </div>
    </div>

    <div class="card">
      <strong class="section-title">Laatste registraties</strong>

      <div class="entry-actions">
        <select id="entryAction">
          <option value="">Kies actie‚Ä¶</option>
          <option value="delete">Verwijder geselecteerden</option>
          <option value="lock">Lock geselecteerden (niet meer aanpasbaar)</option>
          <option value="unlock">Unlock geselecteerden</option>
        </select>
        <button id="applyEntryAction" type="button" class="secondary small">Uitvoeren</button>
      </div>

      <div id="entryList" class="entry-list"></div>
    </div>
  </section>

  <!-- SCHERM 2: OVERZICHT -->
  <section id="screenOverview" class="screen">
    <div class="card">
      <div class="totals">
        <div class="total-box">
          <div class="total-label">Totaal uren</div>
          <div id="totalHours" class="total-value">0 h</div>
        </div>
        <div class="total-box">
          <div class="total-label">Totaal kilometers</div>
          <div id="totalKm" class="total-value">0 km</div>
        </div>
      </div>

      <div style="max-height:260px; overflow:auto;">
        <div class="section-title">Alle registraties</div>
        <table class="overview-table">
          <thead>
          <tr>
            <th>Datum</th>
            <th>Opdrachtgever</th>
            <th>Job</th>
            <th>Tijd</th>
            <th>Uren</th>
            <th>Km</th>
          </tr>
          </thead>
          <tbody id="overviewBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title">Per maand per opdrachtgever</div>
      <div style="max-height:260px; overflow:auto;">
        <table class="overview-table">
          <thead>
          <tr>
            <th>Maand</th>
            <th>Opdrachtgever</th>
            <th>Uren</th>
            <th>Kilometers</th>
          </tr>
          </thead>
          <tbody id="monthlyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast">Gekopieerd üëç</div>

<script>
  const STORAGE_KEY = "urenKmEntries_v2";
  const CLIENTS_KEY = "urenKmClients_v1";
  const THEME_KEY = "urenKmTheme_v1";

  const tabInput = document.getElementById("tabInput");
  const tabOverview = document.getElementById("tabOverview");
  const screenInput = document.getElementById("screenInput");
  const screenOverview = document.getElementById("screenOverview");

  const dateInput = document.getElementById("date");
  const timeFromInput = document.getElementById("timeFrom");
  const timeToInput = document.getElementById("timeTo");
  const hoursInput = document.getElementById("hours");
  const kmInput = document.getElementById("km");
  const clientInput = document.getElementById("client");
  const clientListEl = document.getElementById("clientList");
  const jobInput = document.getElementById("job");

  const saveEntryBtn = document.getElementById("saveEntry");
  const copyLastBtn = document.getElementById("copyLast");
  const entryListEl = document.getElementById("entryList");

  const entryActionSelect = document.getElementById("entryAction");
  const applyEntryActionBtn = document.getElementById("applyEntryAction");

  const totalHoursEl = document.getElementById("totalHours");
  const totalKmEl = document.getElementById("totalKm");
  const overviewBodyEl = document.getElementById("overviewBody");
  const monthlyBodyEl = document.getElementById("monthlyBody");

  const toastEl = document.getElementById("toast");
  const themeToggle = document.getElementById("themeToggle");

  let entries = [];
  let clients = [];
  let manualOverride = false;

  function applyTheme(theme) {
    if (theme === "dark") {
      document.body.classList.add("dark");
      themeToggle.textContent = "‚òÄÔ∏è";
    } else {
      document.body.classList.remove("dark");
      themeToggle.textContent = "üåô";
    }
  }

  const savedTheme = localStorage.getItem(THEME_KEY) || "light";
  applyTheme(savedTheme);

  themeToggle.addEventListener("click", () => {
    const newTheme = document.body.classList.contains("dark") ? "light" : "dark";
    applyTheme(newTheme);
    localStorage.setItem(THEME_KEY, newTheme);
  });

  function loadEntries() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      entries = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(entries)) entries = [];
    } catch {
      entries = [];
    }
  }

  function loadClients() {
    try {
      const raw = localStorage.getItem(CLIENTS_KEY);
      clients = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(clients)) clients = [];
    } catch {
      clients = [];
    }
  }

  function saveEntries() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }

  function saveClients() {
    localStorage.setItem(CLIENTS_KEY, JSON.stringify(clients));
  }

  function formatDateShort(dateStr) {
    if (!dateStr) return "";
    const [y,m,d] = dateStr.split("-");
    if (!y || !m || !d) return dateStr;
    return parseInt(d,10) + "-" + parseInt(m,10);
  }

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 1800);
  }

  function renderClientList() {
    clientListEl.innerHTML = "";
    clients.forEach(c => {
      if (!c) return;
      const opt = document.createElement("option");
      opt.value = c;
      clientListEl.appendChild(opt);
    });
  }

  function addClientName(name) {
    const trimmed = name.trim();
    if (!trimmed) return;
    const exists = clients.some(c => c.toLowerCase() === trimmed.toLowerCase());
    if (!exists) {
      clients.push(trimmed);
      saveClients();
      renderClientList();
    }
  }

  function computeHoursFromTimes() {
    const from = timeFromInput.value;
    const to = timeToInput.value;
    if (!from || !to) return;

    const [fh, fm] = from.split(":").map(Number);
    const [th, tm] = to.split(":").map(Number);
    if (isNaN(fh) || isNaN(fm) || isNaN(th) || isNaN(tm)) return;

    let startMin = fh * 60 + fm;
    let endMin = th * 60 + tm;
    if (endMin <= startMin) endMin += 24 * 60;

    const diffMin = endMin - startMin;
    const hours = diffMin / 60;
    const rounded = Math.round(hours * 100) / 100;
    hoursInput.value = rounded.toString().replace(".", ",").replace(/,00$/, "");
  }

  function ensureDate() {
    if (!dateInput.value) {
      dateInput.value = new Date().toISOString().split("T")[0];
    }
  }

  function renderEntryList() {
    entryListEl.innerHTML = "";
    if (!entries.length) {
      entryListEl.innerHTML = '<div style="font-size:0.8rem;color:var(--muted);">Nog geen registraties.</div>';
      return;
    }

    const sorted = [...entries].sort((a,b) => b.createdAt - a.createdAt);

    for (const e of sorted.slice(0, 40)) {
      const div = document.createElement("div");
      div.className = "entry-item" + (e.locked ? " locked" : "");
      const lockLabel = e.locked ? '<span class="lock-pill">LOCKED</span>' : "";

      div.innerHTML = `
        <input type="checkbox" class="entry-check" data-id="${e.id}">
        <span class="entry-date">${formatDateShort(e.date)}</span>
        <span class="entry-time">${e.timeFrom || "?"} - ${e.timeTo || "?"}</span>
        <span class="entry-clientjob">${e.client || "-"} ‚Ä¢ ${e.job || "-"} ${lockLabel}</span>
        <span class="entry-right">${e.hours || 0}h&nbsp;&nbsp;${e.km || 0}km</span>
      `;
      entryListEl.appendChild(div);
    }
  }

  function renderOverview() {
    let totalHours = 0;
    let totalKm = 0;
    overviewBodyEl.innerHTML = "";

    const sorted = [...entries].sort((a,b)=>a.createdAt-b.createdAt);

    for (const e of sorted) {
      let h = parseFloat((e.hours || "0").toString().replace(",", "."));
      const k = parseFloat(e.km || 0);
      if (!isNaN(h)) totalHours += h;
      if (!isNaN(k)) totalKm += k;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatDateShort(e.date)}</td>
        <td>${e.client || ""}</td>
        <td>${e.job || ""}</td>
        <td>${(e.timeFrom || "?") + " - " + (e.timeTo || "?")}</td>
        <td>${e.hours || ""}</td>
        <td>${e.km || ""}</td>
      `;
      overviewBodyEl.appendChild(tr);
    }

    totalHoursEl.textContent = totalHours.toFixed(2).replace(/\.00$/,"") + " h";
    totalKmEl.textContent = totalKm.toFixed(0) + " km";

    renderMonthlySummary();
  }

  function renderMonthlySummary() {
    monthlyBodyEl.innerHTML = "";
    if (!entries.length) return;

    const map = new Map();

    for (const e of entries) {
      if (!e.date || !e.client) continue;
      const [y,m] = e.date.split("-");
      if (!y || !m) continue;
      const monthKey = y + "-" + m.padStart(2,"0");
      const client = e.client.trim();
      const key = monthKey + "||" + client;

      let hoursVal = parseFloat((e.hours || "0").toString().replace(",", "."));
      if (isNaN(hoursVal)) hoursVal = 0;
      let kmVal = parseFloat(e.km || 0);
      if (isNaN(kmVal)) kmVal = 0;

      if (!map.has(key)) {
        map.set(key, { monthKey, client, hours: 0, km: 0 });
      }
      const item = map.get(key);
      item.hours += hoursVal;
      item.km += kmVal;
    }

    const rows = Array.from(map.values());
    rows.sort((a,b)=>{
      if (a.monthKey < b.monthKey) return 1;
      if (a.monthKey > b.monthKey) return -1;
      return a.client.localeCompare(b.client);
    });

    for (const r of rows) {
      const [year,month] = r.monthKey.split("-");
      const label = parseInt(month,10) + "-" + year;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${label}</td>
        <td>${r.client}</td>
        <td>${r.hours.toFixed(2).replace(/\.00$/,"")}</td>
        <td>${r.km.toFixed(0)}</td>
      `;
      monthlyBodyEl.appendChild(tr);
    }
  }

  function formatEntryForWhatsApp(e) {
    const dateLine = formatDateShort(e.date);
    const timeLine = `${e.timeFrom || "?"} - ${e.timeTo || "?"}`;
    const hoursStr = e.hours !== "" && e.hours != null ? e.hours : "0";
    const kmStr = e.km !== "" && e.km != null ? e.km : "0";
    const line3 = `${hoursStr} h.   ${kmStr} km`;
    const line4 = `${e.client || ""}, ${e.job || ""}`;
    return `${dateLine}
${timeLine}
${line3}
${line4}`;
  }

  function setActiveScreen(screen) {
    if (screen === "input") {
      screenInput.classList.add("active");
      screenOverview.classList.remove("active");
      tabInput.classList.add("active");
      tabOverview.classList.remove("active");
    } else {
      screenInput.classList.remove("active");
      screenOverview.classList.add("active");
      tabInput.classList.remove("active");
      tabOverview.classList.add("active");
      renderOverview();
    }
  }

  tabInput.addEventListener("click", () => setActiveScreen("input"));
  tabOverview.addEventListener("click", () => setActiveScreen("overview"));

  // mark manual override when user edits hours
  hoursInput.addEventListener("input", () => {
    manualOverride = true;
  });

  saveEntryBtn.addEventListener("click", () => {
    ensureDate();
    const date = dateInput.value;
    const timeFrom = timeFromInput.value;
    const timeTo = timeToInput.value;
    let hours = hoursInput.value.trim();
    const km = kmInput.value.trim();
    const client = clientInput.value.trim();
    const job = jobInput.value.trim();

    if (!hours) {
      manualOverride = false;
      computeHoursFromTimes();
      hours = hoursInput.value.trim();
    }

    if (!date || !timeFrom || !timeTo || !hours || !km || !client || !job) {
      showToast("Vul minimaal datum, tijden, uren, km, opdrachtgever & job in.");
      return;
    }

    const entry = {
      id: Date.now() + "_" + Math.random().toString(16).slice(2),
      createdAt: Date.now(),
      date,
      timeFrom,
      timeTo,
      hours,
      km,
      client,
      job,
      locked: false
    };

    entries.push(entry);
    saveEntries();
    addClientName(client);
    renderEntryList();
    renderOverview();
    showToast("Registratie opgeslagen ‚úÖ");
  });

  timeFromInput.addEventListener("change", () => {
    ensureDate();
    if (!manualOverride) computeHoursFromTimes();
  });

  timeToInput.addEventListener("change", () => {
    ensureDate();
    if (!manualOverride) computeHoursFromTimes();
  });

  copyLastBtn.addEventListener("click", async () => {
    if (!entries.length) {
      showToast("Nog geen registraties om te kopi√´ren.");
      return;
    }
    const latest = [...entries].sort((a,b)=>b.createdAt-a.createdAt)[0];
    const text = formatEntryForWhatsApp(latest);

    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        showToast("Tekst gekopieerd. Plak in WhatsApp üì≤");
      } else {
        const tmp = document.createElement("textarea");
        tmp.value = text;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        document.body.removeChild(tmp);
        showToast("Tekst gekopieerd. Plak in WhatsApp üì≤");
      }
    } catch (err) {
      console.error(err);
      showToast("Kopi√´ren mislukt, probeer opnieuw.");
      return;
    }

    const waUrl = "https://wa.me/?text=" + encodeURIComponent(text);
    window.open(waUrl, "_blank");
  });

  applyEntryActionBtn.addEventListener("click", () => {
    const action = entryActionSelect.value;
    if (!action) {
      showToast("Kies eerst een actie.");
      return;
    }
    const checked = Array.from(document.querySelectorAll(".entry-check:checked"));
    const idsSelected = checked.map(cb => cb.dataset.id);
    if (!checked.length) {
      showToast("Geen registraties aangevinkt.");
      return;
    }

    if (action === "delete") {
      const confirmDelete = window.confirm("Weet je zeker dat je de geselecteerde registraties wilt verwijderen?");
      if (!confirmDelete) return;
      entries = entries.filter(e => !(idsSelected.includes(e.id) && !e.locked));
      saveEntries();
      renderEntryList();
      renderOverview();
      showToast("Niet-gelockte registraties verwijderd.");
      entryActionSelect.value = "";
    } else if (action === "lock") {
      entries.forEach(e => {
        if (idsSelected.includes(e.id)) e.locked = true;
      });
      saveEntries();
      renderEntryList();
      renderOverview();
      showToast("Registraties gelockt.");
      entryActionSelect.value = "";
    } else if (action === "unlock") {
      let any = false;
      entries.forEach(e => {
        if (idsSelected.includes(e.id) && e.locked) {
          e.locked = false;
          any = true;
        }
      });
      if (!any) {
        showToast("Geen gelockte registraties geselecteerd.");
      } else {
        saveEntries();
        renderEntryList();
        renderOverview();
        showToast("Geselecteerde registraties ontgrendeld.");
      }
      entryActionSelect.value = "";
    }
  });

  loadEntries();
  loadClients();
  renderClientList();
  renderEntryList();
  renderOverview();
</script>
</body>
</html>
